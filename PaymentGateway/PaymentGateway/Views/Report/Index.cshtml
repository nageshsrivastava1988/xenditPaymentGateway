@model ReportPageViewModel
@{
    ViewData["Title"] = "Report";
    int startPage = Math.Max(1, Model.PageNumber - 2);
    int endPage = Math.Min(Model.TotalPages, startPage + 4);
    if (endPage - startPage < 4)
    {
        startPage = Math.Max(1, endPage - 4);
    }

    string fromQuery = Model.FromDateTimeInput;
    string toQuery = Model.ToDateTimeInput;

    int successCount = Model.Sessions.Count(s => string.Equals(s.Status, "Success", StringComparison.OrdinalIgnoreCase));
    int failedCount = Model.Sessions.Count(s => string.Equals(s.Status, "Failed", StringComparison.OrdinalIgnoreCase));
    int pendingCount = Model.Sessions.Count - successCount - failedCount;
    int pageStartRow = Model.TotalCount == 0 ? 0 : ((Model.PageNumber - 1) * Model.EffectivePageSize) + 1;
    int pageEndRow = Math.Min(Model.TotalCount, Model.PageNumber * Model.EffectivePageSize);
}

<section class="admin-page">
    <header class="page-head">
        <div>
            <h2>Payment Report</h2>
            <p class="page-subtitle">Track payment requests with server-side filters and pagination.</p>
        </div>
    </header>

    <section class="kpi-grid">
        <article class="kpi-card">
            <div class="label">Total Rows</div>
            <div class="value">@Model.TotalCount</div>
        </article>
        <article class="kpi-card">
            <div class="label">Current Page Status</div>
            <div class="value">@successCount Success / @failedCount Failed / @pendingCount Pending</div>
        </article>
        <article class="kpi-card">
            <div class="label">Page Window</div>
            <div class="value">Page @Model.PageNumber of @Model.TotalPages</div>
        </article>
    </section>

    <section class="admin-card">
        <form method="get" asp-action="Index" asp-controller="Report">
            <div class="filters-grid">
                <div class="filter-item">
                    <label class="form-label" for="fromDateTime">From DateTime</label>
                    <input id="fromDateTime" name="fromDateTime" type="datetime-local" class="form-control" value="@Model.FromDateTimeInput" />
                </div>
                <div class="filter-item">
                    <label class="form-label" for="toDateTime">To DateTime</label>
                    <input id="toDateTime" name="toDateTime" type="datetime-local" class="form-control" value="@Model.ToDateTimeInput" />
                </div>
                <div class="filter-item">
                    <label class="form-label" for="status">Status</label>
                    <select id="status" name="status" class="form-select">
                        @if (string.IsNullOrWhiteSpace(Model.Status))
                        {
                            <option value="" selected>All</option>
                        }
                        else
                        {
                            <option value="">All</option>
                        }

                        @if (string.Equals(Model.Status, "Pending", StringComparison.OrdinalIgnoreCase))
                        {
                            <option value="Pending" selected>Pending</option>
                        }
                        else
                        {
                            <option value="Pending">Pending</option>
                        }

                        @if (string.Equals(Model.Status, "Success", StringComparison.OrdinalIgnoreCase))
                        {
                            <option value="Success" selected>Success</option>
                        }
                        else
                        {
                            <option value="Success">Success</option>
                        }

                        @if (string.Equals(Model.Status, "Failed", StringComparison.OrdinalIgnoreCase))
                        {
                            <option value="Failed" selected>Failed</option>
                        }
                        else
                        {
                            <option value="Failed">Failed</option>
                        }
                    </select>
                </div>
                <div class="filter-item">
                    <label class="form-label" for="referenceNo">Reference No</label>
                    <input id="referenceNo" name="referenceNo" type="text" class="form-control" value="@Model.ReferenceNo" placeholder="Invoice reference" />
                </div>
                <div class="filter-item">
                    <label class="form-label" for="pageSize">Page Size</label>
                    <select id="pageSize" name="pageSize" class="form-select">
                        @if (Model.PageSize == 10)
                        {
                            <option value="10" selected>10</option>
                        }
                        else
                        {
                            <option value="10">10</option>
                        }

                        @if (Model.PageSize == 25)
                        {
                            <option value="25" selected>25</option>
                        }
                        else
                        {
                            <option value="25">25</option>
                        }

                        @if (Model.PageSize == 50)
                        {
                            <option value="50" selected>50</option>
                        }
                        else
                        {
                            <option value="50">50</option>
                        }

                        @if (Model.PageSize == 100)
                        {
                            <option value="100" selected>100</option>
                        }
                        else
                        {
                            <option value="100">100</option>
                        }

                        @if (Model.PageSize <= 0)
                        {
                            <option value="0" selected>All</option>
                        }
                        else
                        {
                            <option value="0">All</option>
                        }
                    </select>
                </div>
            </div>

            <input type="hidden" name="page" value="1" />
            <div class="mt-3 d-flex gap-2">
                <button type="submit" class="btn btn-primary">Apply Filters</button>
                <a class="btn btn-outline-secondary" asp-action="Index" asp-controller="Report">Reset</a>
            </div>
        </form>
    </section>

    <section class="admin-card">
        @if (Model.Sessions.Count == 0)
        {
            <div class="empty-state">No records found for the selected filters.</div>
        }
        else
        {
            <div class="table-responsive">
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>Created (UTC)</th>
                            <th>Index Guid</th>
                            <th>Reference No</th>
                            <th>Customer</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Channel</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var session in Model.Sessions)
                        {
                            var statusClass = string.Equals(session.Status, "Success", StringComparison.OrdinalIgnoreCase)
                                ? "status-success"
                                : string.Equals(session.Status, "Failed", StringComparison.OrdinalIgnoreCase)
                                    ? "status-failed"
                                    : "status-pending";
                            <tr>
                                <td>@session.CreatedAtUtc.ToString("yyyy-MM-dd HH:mm:ss")</td>
                                <td><code>@session.IndexGuid</code></td>
                                <td>@(session.InvoiceReference ?? "-")</td>
                                <td>@(session.BilledEntityName ?? "-")</td>
                                <td>@session.Amount.ToString("N2")</td>
                                <td><span class="status-badge @statusClass">@session.Status</span></td>
                                <td>@(session.SelectedChannelCode ?? "-")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }

        <nav class="pager-wrap" aria-label="Report pagination">
            <div class="pager-meta">Showing @pageStartRow to @pageEndRow of @Model.TotalCount rows</div>

            <ul class="pg-pager">
                <li>
                    @if (Model.HasPreviousPage)
                    {
                        <a class="pg-pager-link nav"
                           asp-action="Index"
                           asp-controller="Report"
                           asp-route-page="1"
                           asp-route-pageSize="@Model.PageSize"
                           asp-route-fromDateTime="@fromQuery"
                           asp-route-toDateTime="@toQuery"
                           asp-route-status="@Model.Status"
                           asp-route-referenceNo="@Model.ReferenceNo">First</a>
                    }
                    else
                    {
                        <span class="pg-pager-link nav disabled">First</span>
                    }
                </li>

                <li>
                    @if (Model.HasPreviousPage)
                    {
                        <a class="pg-pager-link nav"
                           asp-action="Index"
                           asp-controller="Report"
                           asp-route-page="@(Model.PageNumber - 1)"
                           asp-route-pageSize="@Model.PageSize"
                           asp-route-fromDateTime="@fromQuery"
                           asp-route-toDateTime="@toQuery"
                           asp-route-status="@Model.Status"
                           asp-route-referenceNo="@Model.ReferenceNo">Prev</a>
                    }
                    else
                    {
                        <span class="pg-pager-link nav disabled">Prev</span>
                    }
                </li>

                @for (int p = startPage; p <= endPage; p++)
                {
                    <li>
                        <a class="pg-pager-link @(p == Model.PageNumber ? "active" : string.Empty)"
                           asp-action="Index"
                           asp-controller="Report"
                           asp-route-page="@p"
                           asp-route-pageSize="@Model.PageSize"
                           asp-route-fromDateTime="@fromQuery"
                           asp-route-toDateTime="@toQuery"
                           asp-route-status="@Model.Status"
                           asp-route-referenceNo="@Model.ReferenceNo">@p</a>
                    </li>
                }

                <li>
                    @if (Model.HasNextPage)
                    {
                        <a class="pg-pager-link nav"
                           asp-action="Index"
                           asp-controller="Report"
                           asp-route-page="@(Model.PageNumber + 1)"
                           asp-route-pageSize="@Model.PageSize"
                           asp-route-fromDateTime="@fromQuery"
                           asp-route-toDateTime="@toQuery"
                           asp-route-status="@Model.Status"
                           asp-route-referenceNo="@Model.ReferenceNo">Next</a>
                    }
                    else
                    {
                        <span class="pg-pager-link nav disabled">Next</span>
                    }
                </li>

                <li>
                    @if (Model.HasNextPage)
                    {
                        <a class="pg-pager-link nav"
                           asp-action="Index"
                           asp-controller="Report"
                           asp-route-page="@Model.TotalPages"
                           asp-route-pageSize="@Model.PageSize"
                           asp-route-fromDateTime="@fromQuery"
                           asp-route-toDateTime="@toQuery"
                           asp-route-status="@Model.Status"
                           asp-route-referenceNo="@Model.ReferenceNo">Last</a>
                    }
                    else
                    {
                        <span class="pg-pager-link nav disabled">Last</span>
                    }
                </li>
            </ul>
        </nav>
    </section>
</section>
