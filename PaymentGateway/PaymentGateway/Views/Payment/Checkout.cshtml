@model PaymentCheckoutViewModel
@{
    ViewData["Title"] = "Payment Checkout";
    var groupedChannels = Model.ChannelOptions
        .GroupBy(c => string.IsNullOrWhiteSpace(c.Type) ? "OTHERS" : c.Type)
        .OrderBy(g => g.Key)
        .ToList();
    var firstGroup = groupedChannels.FirstOrDefault()?.Key ?? string.Empty;
    var selectedChannelName = Model.ChannelOptions
        .FirstOrDefault(c => Model.SelectedChannelId.HasValue
            ? c.Id == Model.SelectedChannelId.Value
            : string.Equals(c.Code, Model.SelectedChannelCode, StringComparison.OrdinalIgnoreCase))
        ?.Name ?? "None";
}

<div class="portal-shell">
    <header class="portal-header">
        <span class="brand-meta">Reference: @Model.IndexGuid</span>
    </header>

    <main class="portal-main">
        <section class="invoice-card">
            <div class="invoice-amount">
                <span class="label">TOTAL AMOUNT</span>
                <h1>@Model.Amount.ToString("N2") <small>@Model.Currency</small></h1>
                <span class="status-chip">@Model.Status</span>
            </div>
            <div class="invoice-details">
                <div><span>Customer</span><strong>@(Model.CustomerName ?? "-")</strong></div>
                <div><span>Invoice Reference</span><strong>@(Model.InvoiceReference ?? "-")</strong></div>
                <div><span>Space</span><strong>@(Model.SpaceName ?? "-")</strong></div>
                <div><span>Market</span><strong>@(string.IsNullOrWhiteSpace(Model.Country) ? "-" : Model.Country) / @(string.IsNullOrWhiteSpace(Model.Currency) ? "-" : Model.Currency)</strong></div>
            </div>
        </section>

        @if (!string.IsNullOrWhiteSpace(Model.ErrorMessage))
        {
            <div class="error">@Model.ErrorMessage</div>
        }

        <section class="section-head">
            <p>Choose your preferred method to complete this transaction securely.</p>
        </section>

        <form asp-action="Checkout" asp-controller="Payment" asp-route-indexGuid="@Model.IndexGuid" method="post">
            @Html.AntiForgeryToken()

            @if (Model.ChannelOptions.Count > 0)
            {
                <nav class="type-tabs" aria-label="Payment Channel Types">
                    @foreach (var group in groupedChannels)
                    {
                        var key = group.Key.ToUpperInvariant();
                        var isActive = string.Equals(firstGroup, group.Key, StringComparison.Ordinal);
                        <button type="button"
                                class="type-tab @(isActive ? "active" : "")"
                                data-target="@key">
                            @group.Key
                        </button>
                    }
                </nav>
            }

            @if (Model.ChannelOptions.Count == 0)
            {
                <p class="error">No payment channels are available for this payable amount.</p>
            }
            else
            {
                @foreach (var group in groupedChannels)
                {
                    var key = group.Key.ToUpperInvariant();
                    var isVisible = string.Equals(firstGroup, group.Key, StringComparison.Ordinal);
                    <section class="channel-group @(isVisible ? "visible" : "")" data-group="@key">
                        <div class="cards">
                            @foreach (var channel in group)
                            {
                                var checkedAttr = Model.SelectedChannelId.HasValue
                                    ? Model.SelectedChannelId.Value == channel.Id
                                    : string.Equals(Model.SelectedChannelCode, channel.Code, StringComparison.OrdinalIgnoreCase);
                                <label class="card">
                                    <span class="card-main">
                                        <span class="name-row">
                                            <input type="radio"
                                                   name="channelId"
                                                   value="@channel.Id"
                                                   checked="@checkedAttr"
                                                   data-channel-name="@channel.Name" />
                                            <span class="name">@channel.Name</span>
                                        </span>
                                    </span>
                                    <span class="market">@channel.Country / @channel.Currency</span>
                                </label>
                            }
                        </div>
                    </section>
                }
            }

            <section class="cta-panel">
                <div class="cta-copy">
                    <span>Selected Payment Channel</span>
                    <strong id="selectedChannelText">@selectedChannelName</strong>
                </div>
                <button type="submit" @(Model.ChannelOptions.Count == 0 ? "disabled" : null)>Proceed to Payment</button>
            </section>
        </form>
    </main>
</div>

<style>
    :root { --primary:#ff5724; --bg:#f8f6f5; --text:#201916; --muted:#6f635d; --line:#eadfd9; --panel:#ffffff; --danger:#b42318; }
    .portal-shell {
        min-height: 100vh;
        background: var(--bg);
        color: var(--text);
        font-family: Inter, "Segoe UI", Roboto, Arial, sans-serif;
    }
    .portal-header {
        position: sticky;
        top: 0;
        z-index: 20;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 18px;
        background: color-mix(in srgb, white 84%, transparent);
        backdrop-filter: blur(6px);
        border-bottom: 1px solid color-mix(in srgb, var(--primary) 20%, transparent);
    }
    .brand { display: flex; align-items: center; gap: 10px; }
    .brand-badge {
        width: 30px;
        height: 30px;
        border-radius: 8px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: var(--primary);
        color: #fff;
        font-size: 12px;
        font-weight: 700;
    }
    .brand-text { font-weight: 700; letter-spacing: .01em; }
    .brand-meta { color: var(--muted); font-size: .86rem; }
    .portal-main {
        max-width: 980px;
        margin: 20px auto;
        padding: 0 14px 24px;
    }
    .invoice-card {
        background: var(--panel);
        border: 1px solid color-mix(in srgb, var(--primary) 18%, transparent);
        border-radius: 18px;
        overflow: hidden;
        display: grid;
        grid-template-columns: 1fr 2fr;
    }
    .invoice-amount {
        background: color-mix(in srgb, var(--primary) 10%, white);
        padding: 26px 22px;
        border-right: 1px solid color-mix(in srgb, var(--primary) 16%, transparent);
    }
    .invoice-amount .label { font-size: .72rem; color: var(--primary); font-weight: 700; letter-spacing: .09em; }
    .invoice-amount h1 { margin: 8px 0; font-size: 2rem; line-height: 1.1; }
    .invoice-amount h1 small { font-size: 1rem; color: var(--muted); }
    .status-chip {
        display: inline-block;
        margin-top: 6px;
        font-size: .76rem;
        font-weight: 700;
        color: #8a4b00;
        background: #ffedcc;
        border-radius: 999px;
        padding: 5px 10px;
    }
    .invoice-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 14px 18px;
        padding: 20px;
    }
    .invoice-details span { display: block; font-size: .72rem; color: var(--muted); text-transform: uppercase; letter-spacing: .05em; margin-bottom: 3px; }
    .invoice-details strong { font-size: .95rem; }
    .section-head { margin: 24px 2px 10px; }
    .section-head h2 { margin: 0 0 4px; font-size: 1.65rem; }
    .section-head p { margin: 0; color: var(--muted); }
    .error {
        color: var(--danger);
        background: #fff2f0;
        border: 1px solid #ffd4cf;
        border-radius: 12px;
        padding: 11px 12px;
        margin: 0 0 12px;
        font-weight: 600;
    }
    .type-tabs {
        display: flex;
        overflow-x: auto;
        border-bottom: 1px solid color-mix(in srgb, var(--primary) 20%, transparent);
        margin-bottom: 14px;
        scrollbar-width: thin;
    }
    .type-tab {
        border: 0;
        background: transparent;
        padding: 11px 16px;
        font-size: .85rem;
        color: var(--muted);
        border-bottom: 2px solid transparent;
        white-space: nowrap;
        cursor: pointer;
        font-weight: 700;
    }
    .type-tab.active { color: var(--primary); border-bottom-color: var(--primary); background: color-mix(in srgb, var(--primary) 8%, transparent); }
    .channel-group { display: none; }
    .channel-group.visible { display: block; }
    .cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 13px;
        margin-bottom: 14px;
    }
    .card {
        border: 2px solid transparent;
        border-radius: 14px;
        padding: 12px;
        cursor: pointer;
        background: var(--panel);
        display: block;
        box-shadow: 0 2px 10px rgba(31, 20, 16, 0.06);
        transition: border-color .18s ease, box-shadow .18s ease;
    }
    .card:hover { border-color: color-mix(in srgb, var(--primary) 45%, transparent); }
    .card:has(input:checked) {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 12%, transparent);
    }
    .card-main { display: block; }
    .name-row { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; }
    .card input { margin: 0; accent-color: var(--primary); }
    .card .name { display: block; font-weight: 700; }
    .card .code {
        display: inline-block;
        margin-bottom: 6px;
        font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
        color: #473a34;
        font-size: 0.8rem;
        background: #f4efed;
        border: 1px solid #ede3de;
        border-radius: 999px;
        padding: 2px 8px;
    }
    .card .market { display: block; color: var(--muted); font-size: 0.82rem; margin-top: 3px; font-weight: 600; }
    .cta-panel {
        margin-top: 8px;
        background: #221813;
        color: #fff;
        border-radius: 16px;
        padding: 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
    }
    .cta-copy span { display: block; font-size: .82rem; color: #c9b9b0; }
    .cta-copy strong { display: block; margin-top: 3px; font-size: 1rem; }
    button {
        background: var(--primary);
        color: #fff;
        border: 0;
        padding: 0.72rem 1.2rem;
        border-radius: 10px;
        font-weight: 700;
        cursor: pointer;
        white-space: nowrap;
    }
    button:hover { background: #ea4d1b; }
    button:disabled { background: #a99d97; cursor: not-allowed; }
    @@media (max-width: 860px) {
        .invoice-card { grid-template-columns: 1fr; }
        .invoice-amount { border-right: 0; border-bottom: 1px solid color-mix(in srgb, var(--primary) 16%, transparent); }
        .invoice-details { grid-template-columns: 1fr; }
        .cta-panel { flex-direction: column; align-items: flex-start; }
        .cta-panel button { width: 100%; }
    }
</style>

<script>
    (function () {
        const tabs = document.querySelectorAll('.type-tab');
        const groups = document.querySelectorAll('.channel-group');
        const radios = document.querySelectorAll('input[name="channelId"]');
        const selectedText = document.getElementById('selectedChannelText');

        function showGroup(target) {
            groups.forEach(g => g.classList.toggle('visible', g.dataset.group === target));
            tabs.forEach(t => t.classList.toggle('active', t.dataset.target === target));
        }

        tabs.forEach(tab => {
            tab.addEventListener('click', () => showGroup(tab.dataset.target));
        });

        radios.forEach(radio => {
            radio.addEventListener('change', () => {
                const name = radio.dataset.channelName || 'None';
                if (selectedText) {
                    selectedText.textContent = name;
                }
            });
        });
    })();
</script>
